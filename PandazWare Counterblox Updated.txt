-- // PANDAZWARE: FINAL MERGED VERSION // --
-- Base: PandazWare Counterblox.txt
-- Added: Wallbang, SkinChanger, Spinbot Logic (from testing.txt)
-- Library: Raw Link

getgenv().SecureMode = true

-- // 1. SERVICES // --
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = Workspace:FindFirstChild("Debris")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- // 2. LOAD LIBRARY // --
-- Lädt deine Library direkt über den Link (mit Slider Support)
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/PandazWare/PandazWare/refs/heads/main/PandazWare%20libary"))()

-- // 3. SETTINGS (FLAGS) // --
local Flags = {
    -- Legit
    Aimbot = false, FOV = 100, Smooth = 0.5, WallCheck = true, HitChance = 100, ShowFOV = false,
    -- Rage
    SilentAim = false, Hitbox = false, HitboxSize = 4, Spinbot = false, SpinSpeed = 50,
    Wallbang = false, -- [NEU]
    -- Visuals
    ESP_Chams = false, ESP_Box = false, ESP_Skel = false, ESP_Trace = false, 
    Fullbright = false, ClearMap = false, 
    SkinChanger = false, -- [NEU]
    -- Gun Mods
    NoRecoil = false, NoSpread = false, RapidFire = false, InfAmmo = false, InstaReload = false,
    -- Misc
    TP = false, TPDist = 12, Speed = false, SpeedVal = 16, Bhop = false
}

-- Create Window
local Window = Library:CreateWindow({
    Title = "PandazWare"
})

Library:Notify("PandazWare", "Update Loaded!", 3)
-- // PANDAZWARE: PART 2 - LOGIC // --

-- [ VISUAL DRAWINGS SETUP ]
local FOVCircle = Drawing.new("Circle")
FOVCircle.Color = Color3.fromRGB(0, 255, 170)
FOVCircle.Thickness = 1.5; FOVCircle.NumSides = 60; FOVCircle.Visible = false; FOVCircle.Filled = false

local DrawCache = {Skeleton = {}, Tracers = {}, Chams = {}}
local SkeletonConnections = {{"Head", "UpperTorso"}, {"UpperTorso", "LowerTorso"}, {"Head", "Torso"}, {"UpperTorso", "LeftUpperArm"}, {"LeftUpperArm", "LeftLowerArm"}, {"LeftLowerArm", "LeftHand"}, {"UpperTorso", "RightUpperArm"}, {"RightUpperArm", "RightLowerArm"}, {"RightLowerArm", "RightHand"}, {"Torso", "Left Arm"}, {"Torso", "Right Arm"}, {"LowerTorso", "LeftUpperLeg"}, {"LeftUpperLeg", "LeftLowerLeg"}, {"LeftLowerLeg", "LeftFoot"}, {"LowerTorso", "RightUpperLeg"}, {"RightUpperLeg", "RightLowerLeg"}, {"RightLowerLeg", "RightFoot"}, {"Torso", "Left Leg"}, {"Torso", "Right Leg"}}

-- [ ESP FUNCTIONS (Datei 1) ]
local function UpdateSkeleton(plr)
    if not DrawCache.Skeleton[plr] then DrawCache.Skeleton[plr] = {} end
    local cache = DrawCache.Skeleton[plr]
    if Flags.ESP_Skel and plr.Character and plr.Team ~= LocalPlayer.Team then
        for i, pair in pairs(SkeletonConnections) do
            local partA, partB = plr.Character:FindFirstChild(pair[1]), plr.Character:FindFirstChild(pair[2])
            if partA and partB then
                local line = cache[i] or Drawing.new("Line")
                line.Thickness = 1.5; line.Color = Color3.fromRGB(255, 255, 255); line.Transparency = 1; cache[i] = line
                local vecA, visA = Camera:WorldToViewportPoint(partA.Position)
                local vecB, visB = Camera:WorldToViewportPoint(partB.Position)
                if visA and visB then line.Visible = true; line.From = Vector2.new(vecA.X, vecA.Y); line.To = Vector2.new(vecB.X, vecB.Y) else line.Visible = false end
            else if cache[i] then cache[i].Visible = false end end
        end
    else for _, line in pairs(cache) do line.Visible = false end end
end

local function UpdateChams(plr)
    if not plr.Character then return end
    if not Flags.ESP_Chams or plr.Team == LocalPlayer.Team then
        if DrawCache.Chams[plr] then for _, v in pairs(DrawCache.Chams[plr]) do v:Destroy() end DrawCache.Chams[plr] = nil end
        return
    end
    if not DrawCache.Chams[plr] then DrawCache.Chams[plr] = {} end
    for _, part in pairs(plr.Character:GetChildren()) do
        if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" and not DrawCache.Chams[plr][part] then
            local cham = Instance.new("BoxHandleAdornment")
            cham.Name = "PZ_Cham"; cham.Adornee = part; cham.Parent = part; cham.Size = part.Size; cham.Color3 = Color3.fromRGB(0, 255, 170); cham.AlwaysOnTop = true; cham.ZIndex = 5; cham.Transparency = 0.5
            DrawCache.Chams[plr][part] = cham
        end
    end
end

local function UpdateTracers(plr)
    if not DrawCache.Tracers[plr] then local t = Drawing.new("Line"); t.Thickness = 1; t.Color = Color3.fromRGB(0, 255, 170); DrawCache.Tracers[plr] = t end
    local line = DrawCache.Tracers[plr]
    if Flags.ESP_Trace and plr.Character and plr.Team ~= LocalPlayer.Team and plr.Character:FindFirstChild("HumanoidRootPart") then
        local vec, vis = Camera:WorldToViewportPoint(plr.Character.HumanoidRootPart.Position)
        if vis then line.Visible = true; line.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y); line.To = Vector2.new(vec.X, vec.Y) else line.Visible = false end
    else line.Visible = false end
end

-- [ TARGET LOGIC ]
local function GetTarget()
    local closest, maxDist = nil, Flags.FOV
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Team ~= LocalPlayer.Team and p.Character and p.Character:FindFirstChild("Head") and p.Character.Humanoid.Health > 0 then
            local targetPart = p.Character.Head
            if math.random(1, 100) > Flags.HitChance then targetPart = p.Character:FindFirstChild("UpperTorso") or p.Character.Head end
            local pos, vis = Camera:WorldToViewportPoint(targetPart.Position)
            if vis then
                local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                if dist < maxDist then
                    local isVisible = true
                    if Flags.WallCheck then
                        local ray = Ray.new(Camera.CFrame.Position, (targetPart.Position - Camera.CFrame.Position).Unit * 500)
                        local hit = Workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character, Camera})
                        if hit and not hit:IsDescendantOf(p.Character) then isVisible = false end
                    end
                    if isVisible then closest = targetPart; maxDist = dist end
                end
            end
        end
    end
    return closest
end

-- [ OLD GUN MODS (Datei 1 - UNVERÄNDERT) ]
local function ApplyGunMods()
    local W = ReplicatedStorage:WaitForChild("Weapons")
    for _, w in ipairs(W:GetChildren()) do
        if Flags.RapidFire and w:FindFirstChild("FireRate") then w.FireRate.Value = 0 end
        if Flags.NoSpread then
             local s = w:FindFirstChild("Spread")
             if s then
                if s:IsA("ValueBase") then s.Value = 0 end
                for _, c in ipairs(s:GetChildren()) do if c:IsA("NumberValue") then c.Value = 0 end end
             end
        end
        if Flags.NoRecoil then
             local r = w:FindFirstChild("Recoil")
             if r then for _, c in ipairs(r:GetChildren()) do if c:IsA("NumberValue") then c.Value = 0 end end end
        end
        if Flags.InfAmmo and w:FindFirstChild("Ammo") then w.Ammo.Value = 999 end
        if Flags.InfAmmo and w:FindFirstChild("StoredAmmo") then w.StoredAmmo.Value = 9999 end
        if Flags.InstaReload and w:FindFirstChild("ReloadTime") then w.ReloadTime.Value = 0.05 end
    end
end

-- [ NEW: SKIN CHANGER (Datei 2) ]
local function ApplySkins()
    if not Flags.SkinChanger then return end
    local SkinsFolder = ReplicatedStorage:FindFirstChild("Skins")
    if not SkinsFolder then return end
    
    local Character = LocalPlayer.Character
    if not Character then return end
    
    for _, Tool in pairs(Character:GetChildren()) do
        if Tool:IsA("Tool") then
            -- Einfacher Neon Skin Apply (Pandaz Style)
            for _, Part in pairs(Tool:GetDescendants()) do
                if Part:IsA("MeshPart") or Part:IsA("UnionOperation") then
                    if Part.Material ~= Enum.Material.Neon then
                        Part.Material = Enum.Material.Neon
                        Part.Color = Color3.fromRGB(0, 255, 170)
                    end
                end
            end
        end
    end
end
-- // PANDAZWARE: PART 3 - UI & HOOKS // --

-- [ TABS & UI ELEMENTS ]
local Legit = Window:CreateTab("Legit")
Legit:Toggle("Aimbot", false, function(v) Flags.Aimbot = v end)
Legit:Slider("FOV Radius", 10, 400, 100, function(v) Flags.FOV = v end)
Legit:Slider("Smoothness", 0, 10, 5, function(v) Flags.Smooth = v/10 end)
Legit:Slider("Hit Chance %", 0, 100, 100, function(v) Flags.HitChance = v end)
Legit:Toggle("Wall Check", true, function(v) Flags.WallCheck = v end)
Legit:Toggle("Show FOV Circle", false, function(v) Flags.ShowFOV = v end)

local Rage = Window:CreateTab("Rage")
Rage:Toggle("Silent Aim", false, function(v) Flags.SilentAim = v end)
Rage:Toggle("Wallbang", false, function(v) Flags.Wallbang = v end) -- [NEU]
Rage:Toggle("Hitbox Extender", false, function(v) Flags.Hitbox = v end)
Rage:Slider("Hitbox Size", 2, 15, 4, function(v) Flags.HitboxSize = v end)
Rage:Toggle("Spinbot", false, function(v) Flags.Spinbot = v end)
Rage:Slider("Spin Speed", 10, 100, 50, function(v) Flags.SpinSpeed = v end)

local Visuals = Window:CreateTab("Visuals")
Visuals:Toggle("Chams (Wallhack)", false, function(v) Flags.ESP_Chams = v end)
Visuals:Toggle("Box ESP", false, function(v) Flags.ESP_Box = v end)
Visuals:Toggle("Skeleton ESP", false, function(v) Flags.ESP_Skel = v end)
Visuals:Toggle("Tracers", false, function(v) Flags.ESP_Trace = v end)
Visuals:Toggle("Fullbright", false, function(v) Flags.Fullbright = v end)
Visuals:Toggle("Clear Map", false, function(v) Flags.ClearMap = v end)
Visuals:Toggle("Skin Changer", false, function(v) Flags.SkinChanger = v end) -- [NEU]

local Gun = Window:CreateTab("Guns")
Gun:Toggle("No Recoil", false, function(v) Flags.NoRecoil = v end)
Gun:Toggle("No Spread", false, function(v) Flags.NoSpread = v end)
Gun:Toggle("Rapid Fire", false, function(v) Flags.RapidFire = v end)
Gun:Toggle("Infinite Ammo", false, function(v) Flags.InfAmmo = v end)
Gun:Toggle("Instant Reload", false, function(v) Flags.InstaReload = v end)

local Misc = Window:CreateTab("Misc")
Misc:Toggle("3rd Person", false, function(v) Flags.TP = v end)
Misc:Slider("TP Distance", 5, 30, 12, function(v) Flags.TPDist = v end)
Misc:Toggle("Speed Hack", false, function(v) Flags.Speed = v end)
Misc:Slider("Speed Value", 16, 100, 25, function(v) Flags.SpeedVal = v end)
Misc:Toggle("Auto Bhop", false, function(v) Flags.Bhop = v end)

-- [ HOOKS (Datei 2 Logic integriert) ]
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()
    
    -- 1. Silent Aim (Override Target)
    if Flags.SilentAim and method == "FireServer" and (self.Name == "Fire" or self.Name == "Shoot") then
        local t = GetTarget()
        if t then
            for i, v in pairs(args) do
                if typeof(v) == "Vector3" then args[i] = t.Position end
            end
            return oldNamecall(self, unpack(args))
        end
    end

    -- 2. Wallbang Hook (Aus Datei 2)
    -- Fügt die Map zur Ignore-Liste hinzu, damit Raycasts durch Wände gehen
    if Flags.Wallbang and (method == "FindPartOnRayWithIgnoreList" or method == "Raycast") then
        if method == "FindPartOnRayWithIgnoreList" then
            local ignoreList = args[2] or {}
            table.insert(ignoreList, Workspace:FindFirstChild("Map") or Workspace) -- Map ignorieren
            args[2] = ignoreList
            return oldNamecall(self, unpack(args))
        end
    end
    
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)


-- [ MAIN LOOPS ]
RunService.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    FOVCircle.Radius = Flags.FOV; FOVCircle.Visible = Flags.ShowFOV

    -- Aimbot Logic
    if Flags.Aimbot and not Flags.SilentAim then
        local t = GetTarget()
        if t then Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, t.Position), 1 - Flags.Smooth) end
    end

    -- Spinbot Logic (Datei 2 Feature)
    if Flags.Spinbot and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.Angles(0, math.rad(Flags.SpinSpeed), 0)
    end
    
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then UpdateSkeleton(p); UpdateTracers(p); UpdateChams(p) end
    end
end)

local AdornmentCache = {}
task.spawn(function()
    while true do
        task.wait(0.1)
        
        -- Gun Mods (Datei 1 Logic)
        if Flags.NoRecoil or Flags.NoSpread or Flags.RapidFire or Flags.InfAmmo or Flags.InstaReload then ApplyGunMods() end
        
        -- Skin Changer (Datei 2 Logic)
        if Flags.SkinChanger then ApplySkins() end
        
        -- Misc
        if Flags.ClearMap then if Debris then Debris:ClearAllChildren() end Lighting.FogEnd = 999999 end
        if Flags.Fullbright then Lighting.Brightness = 2; Lighting.ClockTime = 14 else Lighting.Brightness = 1 end
        if Flags.Speed and LocalPlayer.Character then LocalPlayer.Character.Humanoid.WalkSpeed = Flags.SpeedVal end
        
        -- Box ESP
        if Flags.ESP_Box then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Team ~= LocalPlayer.Team and p.Character then
                    if not AdornmentCache[p] then
                        local b = Instance.new("BoxHandleAdornment", p.Character)
                        b.Adornee = p.Character:FindFirstChild("HumanoidRootPart"); b.Size = Vector3.new(4,5,1); b.AlwaysOnTop = true; b.Transparency = 0.5; b.Color3 = Color3.fromRGB(0, 255, 170)
                        AdornmentCache[p] = b
                    end
                end
            end
        else for i,v in pairs(AdornmentCache) do v:Destroy() end AdornmentCache = {} end

        -- Hitbox
        if Flags.Hitbox then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Team ~= LocalPlayer.Team and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    local root = p.Character.HumanoidRootPart
                    root.Size = Vector3.new(Flags.HitboxSize, Flags.HitboxSize, Flags.HitboxSize)
                    root.Transparency = 0.7; root.CanCollide = false; root.Material = Enum.Material.Neon; root.Color = Color3.fromRGB(255, 0, 0)
                end
            end
        end
        
        -- Bhop & TP
        if Flags.Bhop and LocalPlayer.Character then if LocalPlayer.Character.Humanoid.MoveDirection.Magnitude > 0 and LocalPlayer.Character.Humanoid.FloorMaterial ~= Enum.Material.Air then LocalPlayer.Character.Humanoid.Jump = true end end
        if Flags.TP then LocalPlayer.CameraMode = Enum.CameraMode.Classic; LocalPlayer.CameraMaxZoomDistance = Flags.TPDist; LocalPlayer.CameraMinZoomDistance = Flags.TPDist else LocalPlayer.CameraMode = Enum.CameraMode.LockFirstPerson; LocalPlayer.CameraMaxZoomDistance = 0.5 end
    end
end)

