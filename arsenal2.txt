--[[
    PandazWare: Arsenal "Sticky Rage" + High Quality ESP
    - ESP Source: esp.lua.txt (Drawings: Box, Skeleton, Chams)
    - Rage Source: Custom "Sticky" Follow (2 Studs)
    - Aimbot Source: OffenseWare
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- // 1. LIBRARY LOAD //
local LibraryURL = "https://raw.githubusercontent.com/PandazWare/PandazWare/refs/heads/main/PandazWare%20libary"
local success, PandazWare = pcall(function() return loadstring(game:HttpGet(LibraryURL))() end)

if not success or not PandazWare then return warn("Lib Failed") end

-- // 2. CONFIGURATION //
getgenv().Config = {
    Combat = {
        Aimbot = false,
        FOV = 120,
        Smoothing = 0.5,
        WallCheck = true,
        TargetPart = "Head"
    },
    Rage = {
        KillAll = false,
        FollowDistance = 2, -- 2 Studs distance [User Request]
        AutoShoot = true,
        Fly = false,
        FlySpeed = 60
    },
    [span_1](start_span)Visuals = { -- Settings based on esp.lua.txt [cite: 486-489]
        Enabled = false,
        Boxes = true,
        BoxType = "Corner", -- Corner or Full
        Skeletons = true,
        Chams = false,
        ChamsFill = Color3.fromRGB(255, 0, 0),
        ChamsOutline = Color3.fromRGB(255, 255, 255),
        SkeletonColor = Color3.fromRGB(255, 255, 255),
        EnemyColor = Color3.fromRGB(255, 40, 40)
    },
    Gun = {
        InfAmmo = false,
        RapidFire = false,
        NoRecoil = false
    }
}

-- // 3. UTILITIES //
local function IsEnemy(plr)
    if not plr or not plr.Team then return true end
    return plr.Team ~= LocalPlayer.Team
end

local function IsVisible(targetPart)
    if not Config.Combat.WallCheck then return true end
    local origin = Camera.CFrame.Position
    local direction = targetPart.Position - origin
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalPlayer.Character, Camera}
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.IgnoreWater = true
    local result = Workspace:Raycast(origin, direction, params)
    return not result or result.Instance:IsDescendantOf(targetPart.Parent)
end

-- FOV Circle (OffenseWare Style)
local FOVCircle = Drawing.new("Circle")
FOVCircle.Visible = false
FOVCircle.Color = Color3.fromRGB(170, 60, 255)
FOVCircle.Thickness = 1.5
FOVCircle.NumSides = 24
FOVCircle.Filled = false

RunService.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    FOVCircle.Radius = Config.Combat.FOV
    FOVCircle.Visible = Config.Combat.Aimbot
end)
--[[
    PandazWare: Sticky Rage & Combat Logic
]]

-- // RAGE LOGIC: STICKY TARGET //
local StickyTarget = nil

local function GetRageTarget()
    local closest, shortest = nil, math.huge
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and IsEnemy(v) and v.Character then
            local root = v.Character:FindFirstChild("HumanoidRootPart")
            local hum = v.Character:FindFirstChild("Humanoid")
            if root and hum and hum.Health > 0 then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - root.Position).Magnitude
                if dist < shortest then
                    shortest = dist
                    closest = v
                end
            end
        end
    end
    return closest
end

RunService.RenderStepped:Connect(function()
    if not Config.Rage.KillAll then 
        StickyTarget = nil
        return 
    end

    local MyChar = LocalPlayer.Character
    local MyRoot = MyChar and MyChar:FindFirstChild("HumanoidRootPart")
    
    -- Validierung
    if StickyTarget then
        if not StickyTarget.Character or 
           not StickyTarget.Character:FindFirstChild("HumanoidRootPart") or 
           not StickyTarget.Character:FindFirstChild("Humanoid") or 
           StickyTarget.Character.Humanoid.Health <= 0 then
            StickyTarget = nil
        end
    end

    -- Zielsuche
    if not StickyTarget then
        StickyTarget = GetRageTarget()
    end

    -- Ausführung (Stick & Kill)
    if StickyTarget and MyRoot then
        local EnemyRoot = StickyTarget.Character.HumanoidRootPart
        local EnemyHead = StickyTarget.Character:FindFirstChild("Head")
        
        if EnemyRoot and EnemyHead then
            -- 1. Teleport/Sticky Logic (2 Studs hinter Gegner)
            local behindCFrame = EnemyRoot.CFrame * CFrame.new(0, 0, Config.Rage.FollowDistance)
            MyRoot.CFrame = behindCFrame
            MyRoot.Velocity = Vector3.new(0,0,0) -- Physik neutralisieren

            -- 2. Aim Lock
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, EnemyHead.Position)

            -- 3. Auto Shoot
            if Config.Rage.AutoShoot then
                VirtualUser:CaptureController()
                VirtualUser:Button1Down(Vector2.new(0,0), Camera.CFrame)
            end
        end
    else
        VirtualUser:Button1Up(Vector2.new(0,0), Camera.CFrame)
    end
end)

-- // LEGIT AIMBOT (OffenseWare) //
local function GetLegitTarget()
    local closest, shortest = nil, math.huge
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and IsEnemy(v) and v.Character then
            local part = v.Character:FindFirstChild(Config.Combat.TargetPart)
            local hum = v.Character:FindFirstChild("Humanoid")
            
            if part and hum and hum.Health > 0 then
                local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                    if dist < shortest and dist <= Config.Combat.FOV then
                        if IsVisible(part) then
                            closest = part
                            shortest = dist
                        end
                    end
                end
            end
        end
    end
    return closest
end

RunService.RenderStepped:Connect(function()
    if Config.Combat.Aimbot and not Config.Rage.KillAll then
        local target = GetLegitTarget()
        if target then
            Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, target.Position), Config.Combat.Smoothing)
        end
    end
end)

-- // GUN MODS //
task.spawn(function()
    local wkspc = ReplicatedStorage:WaitForChild("wkspc", 5)
    local Weapons = ReplicatedStorage:WaitForChild("Weapons", 5)
    while task.wait(1) do
        if Config.Gun.InfAmmo and wkspc and wkspc:FindFirstChild("CurrentCurse") then
            if wkspc.CurrentCurse.Value ~= "Infinite Ammo" then wkspc.CurrentCurse.Value = "Infinite Ammo" end
        end
        if Weapons and (Config.Gun.RapidFire or Config.Gun.NoRecoil) then
            for _, v in ipairs(Weapons:GetChildren()) do
                if Config.Gun.RapidFire then
                    local fr = v:FindFirstChild("FireRate"); if fr then fr.Value = 0.04 end
                    local auto = v:FindFirstChild("Auto"); if auto then auto.Value = true end
                end
                if Config.Gun.NoRecoil then
                    local rc = v:FindFirstChild("RecoilControl"); if rc then rc.Value = 0 end
                    local sp = v:FindFirstChild("Spread"); if sp then sp.Value = 0 end
                end
            end
        end
    end
end)
--[[
    PandazWare: Advanced ESP (Drawing API)
    [cite_start]Source: esp.lua.txt [cite: 490-500]
]]

local Drawings = {Boxes = {}, Skeletons = {}, Highlights = {}}

-- Helper functions from esp.lua.txt
local function CreateDrawingLine()
    local l = Drawing.new("Line")
    l.Visible = false
    l.Color = Config.Visuals.EnemyColor
    l.Thickness = 1.5
    l.Transparency = 1
    return l
end

local function CreateESP(player)
    if Drawings.Boxes[player] then return end
    
    [cite_start]-- 1. Box Drawings (Corner Style Support)[span_1](end_span)
    local box = {
        TL = CreateDrawingLine(), TR = CreateDrawingLine(),
        BL = CreateDrawingLine(), BR = CreateDrawingLine(),
        L = CreateDrawingLine(), R = CreateDrawingLine(),
        T = CreateDrawingLine(), B = CreateDrawingLine()
    }
    Drawings.Boxes[player] = box
    
    -[span_2](start_span)- 2. Skeleton Drawings[span_2](end_span)
    local skeleton = {}
    for i=1, 15 do table.insert(skeleton, CreateDrawingLine()) end
    Drawings.Skeletons[player] = skeleton
    
    -[span_3](start_span)- 3. Chams (Highlight)[span_3](end_span)
    local hl = Instance.new("Highlight")
    hl.FillColor = Config.Visuals.ChamsFill
    hl.OutlineColor = Config.Visuals.ChamsOutline
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    Drawings.Highlights[player] = hl
end

local function RemoveESP(player)
    if Drawings.Boxes[player] then
        for _, l in pairs(Drawings.Boxes[player]) do l:Remove() end
        Drawings.Boxes[player] = nil
    end
    if Drawings.Skeletons[player] then
        for _, l in pairs(Drawings.Skeletons[player]) do l:Remove() end
        Drawings.Skeletons[player] = nil
    end
    if Drawings.Highlights[player] then
        Drawings.Highlights[player]:Destroy()
        Drawings.Highlights[player] = nil
    end
end

local function UpdateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if not Drawings.Boxes[player] then CreateESP(player) end
            
            local char = player.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            local hum = char and char:FindFirstChild("Humanoid")
            local show = Config.Visuals.Enabled and IsEnemy(player) and char and hrp and hum and hum.Health > 0
            
            -- Chams Update
            local hl = Drawings.Highlights[player]
            if hl then
                if show and Config.Visuals.Chams then
                    hl.Parent = char
                    hl.Enabled = true
                else
                    hl.Enabled = false
                end
            end

            -- Calculation for Drawings
            local onScreen = false
            local boxPos, boxSize
            if show then
                local pos, vis = Camera:WorldToViewportPoint(hrp.Position)
                onScreen = vis
                if onScreen then
                    local size = char:GetExtentsSize()
                    local top = Camera:WorldToViewportPoint((hrp.CFrame * CFrame.new(0, size.Y/2, 0)).Position)
                    local bottom = Camera:WorldToViewportPoint((hrp.CFrame * CFrame.new(0, -size.Y/2, 0)).Position)
                    local height = math.abs(top.Y - bottom.Y)
                    local width = height * 0.6
                    boxPos = Vector2.new(top.X - width/2, top.Y)
                    boxSize = Vector2.new(width, height)
                end
            end

            -[span_4](start_span)- Box Update (Corner Style Logic from esp.lua.txt[span_4](end_span))
            local b = Drawings.Boxes[player]
            if show and onScreen and Config.Visuals.Boxes then
                local len = boxSize.X * 0.2
                -- Top Left
                b.TL.From = boxPos; b.TL.To = boxPos + Vector2.new(len, 0); b.TL.Visible = true
                b.L.From = boxPos; b.L.To = boxPos + Vector2.new(0, len); b.L.Visible = true
                -- Top Right
                b.TR.From = boxPos + Vector2.new(boxSize.X, 0); b.TR.To = boxPos + Vector2.new(boxSize.X - len, 0); b.TR.Visible = true
                b.R.From = boxPos + Vector2.new(boxSize.X, 0); b.R.To = boxPos + Vector2.new(boxSize.X, len); b.R.Visible = true
                -- Bottom Left
                b.BL.From = boxPos + Vector2.new(0, boxSize.Y); b.BL.To = boxPos + Vector2.new(len, boxSize.Y); b.BL.Visible = true
                b.B.From = boxPos + Vector2.new(0, boxSize.Y); b.B.To = boxPos + Vector2.new(0, boxSize.Y - len); b.B.Visible = true
                -- Bottom Right
                b.BR.From = boxPos + Vector2.new(boxSize.X, boxSize.Y); b.BR.To = boxPos + Vector2.new(boxSize.X - len, boxSize.Y); b.BR.Visible = true
                b.T.From = boxPos + Vector2.new(boxSize.X, boxSize.Y); b.T.To = boxPos + Vector2.new(boxSize.X, boxSize.Y - len); b.T.Visible = true
            else
                for _, l in pairs(b) do l.Visible = false end
            end

            -[span_5](start_span)- Skeleton Update (Logic from esp.lua.txt[span_5](end_span))
            local skel = Drawings.Skeletons[player]
            if show and onScreen and Config.Visuals.Skeletons then
                -- Definiere Verbindungen manuell für R15/R6 Support (Simplified)
                local function Line(idx, p1, p2)
                    local part1 = char:FindFirstChild(p1)
                    local part2 = char:FindFirstChild(p2)
                    if part1 and part2 then
                        local pos1 = Camera:WorldToViewportPoint(part1.Position)
                        local pos2 = Camera:WorldToViewportPoint(part2.Position)
                        skel[idx].From = Vector2.new(pos1.X, pos1.Y)
                        skel[idx].To = Vector2.new(pos2.X, pos2.Y)
                        skel[idx].Color = Config.Visuals.SkeletonColor
                        skel[idx].Visible = true
                    else
                        skel[idx].Visible = false
                    end
                end
                Line(1, "Head", "UpperTorso")
                Line(2, "UpperTorso", "LowerTorso")
                Line(3, "UpperTorso", "LeftUpperArm"); Line(4, "LeftUpperArm", "LeftLowerArm"); Line(5, "LeftLowerArm", "LeftHand")
                Line(6, "UpperTorso", "RightUpperArm"); Line(7, "RightUpperArm", "RightLowerArm"); Line(8, "RightLowerArm", "RightHand")
                Line(9, "LowerTorso", "LeftUpperLeg"); Line(10, "LeftUpperLeg", "LeftLowerLeg"); Line(11, "LeftLowerLeg", "LeftFoot")
                Line(12, "LowerTorso", "RightUpperLeg"); Line(13, "RightUpperLeg", "RightLowerLeg"); Line(14, "RightLowerLeg", "RightFoot")
            else
                for _, l in pairs(skel) do l.Visible = false end
            end
        end
    end
end

RunService.RenderStepped:Connect(UpdateESP)
Players.PlayerRemoving:Connect(RemoveESP)

-- // UI SETUP //
local Window = PandazWare:CreateWindow({Title = "PandazWare | Sticky Rage"})

-- RAGE TAB
local Rage = Window:CreateTab("Rage")
Rage:Toggle("Kill All (2 Studs Follow)", false, function(v) 
    Config.Rage.KillAll = v
    if v then PandazWare:Notify("Active", "Sticking to targets...", 3) end
end)
Rage:Toggle("Auto Shoot", true, function(v) Config.Rage.AutoShoot = v end)

-- COMBAT TAB
local Combat = Window:CreateTab("Combat")
Combat:Toggle("Aimbot Active", false, function(v) Config.Combat.Aimbot = v end)
Combat:Slider("FOV Radius", 10, 500, 120, function(v) Config.Combat.FOV = v end)
Combat:Slider("Smoothing", 0, 100, 50, function(v) Config.Combat.Smoothing = v/100 end)

-- VISUALS TAB
local Vis = Window:CreateTab("Visuals")
Vis:Toggle("ESP Active", false, function(v) Config.Visuals.Enabled = v end)
Vis:Toggle("Corner Boxes", true, function(v) Config.Visuals.Boxes = v end)
Vis:Toggle("Skeletons", true, function(v) Config.Visuals.Skeletons = v end)
Vis:Toggle("Chams", false, function(v) Config.Visuals.Chams = v end)

-- GUN TAB
local Gun = Window:CreateTab("Weapons")
Gun:Toggle("Infinite Ammo", false, function(v) Config.Gun.InfAmmo = v end)
Gun:Toggle("Rapid Fire", false, function(v) Config.Gun.RapidFire = v end)
Gun:Toggle("No Recoil", false, function(v) Config.Gun.NoRecoil = v end)

PandazWare:Notify("Loaded", "Sticky Rage Script Ready", 3)
